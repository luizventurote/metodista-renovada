<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Pagamento - Retiro Igreja Metodista Renovada</title>
    <meta name="robots" content="noindex" />
</head>

<body>

    <div style="max-width: 330px;text-align: center;margin: auto;padding: 50px 0 10px;">

        <h1 style="line-height: 38px;">Pagamento</h1>

        <p>Nós recebemos os seus dados corretamente! Agora você precisa realizar o pagamento para finalizar a sua inscrição do retiro.</p>

    </div>

    <div id="payment_link">
        <a href="#" class="links" style="opacity: 0.6;">Carregando...</a>
    </div>

    <script>

        // Get the URL parameters
        var urlParams = new URLSearchParams(window.location.search);

        // Get id, name and payment_method
        var id = urlParams.get('id');
        var name = urlParams.get('name');
        var payment_method = urlParams.get('payment_method');

        var paymentUrl = '/.netlify/functions/retiro-generate-payment-link?id=' + id + '&payment_method=' + payment_method + '&name=' + name + '';

        // Make a fetch request to paymentUrl
        fetch(paymentUrl)
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                console.log(data);
                insertButtonIntoPage(data.result.url);
                sendPaymentLinkToAirtable(data.result.url, id);
            });

        function insertButtonIntoPage(url) {

            // Add a link into the page with the payment information
            var link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('class', 'links ative-green-link');
            link.innerHTML = 'Clique aqui para pagar';

            document.getElementById('payment_link').innerHTML = '';

            document.getElementById('payment_link').appendChild(link);
        }

        function sendPaymentLinkToAirtable(paymentLink, id) {

            let webhookUrl = 'http://localhost:8888/.netlify/functions/retiro-send-payment-link-airtable?id='+id+'&payment_link='+paymentLink;

            fetch(webhookUrl)
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                console.log(data);
            });
        }

    </script>

</body>

</html>